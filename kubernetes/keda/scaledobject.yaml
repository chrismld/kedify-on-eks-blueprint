apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: vllm-queue-scaler
  namespace: default
spec:
  scaleTargetRef:
    name: vllm
  minReplicaCount: 1
  maxReplicaCount: 10
  pollingInterval: 2          # Poll every 2 seconds for faster reaction
  cooldownPeriod: 300
  triggers:
  - type: kedify-otel
    name: running
    metadata:
      scalerAddress: 'kedify-otel-scaler.keda.svc:4318'
      metricQuery: 'sum(vllm_num_requests_running)'
      targetValue: '5'        # Scale when 5 running requests (very aggressive)
      clampMin: '0'
      clampMax: '500'
      operationOverTime: 'last_one'
  - type: kedify-otel
    name: waiting
    metadata:
      scalerAddress: 'kedify-otel-scaler.keda.svc:4318'
      metricQuery: 'sum(vllm_num_requests_waiting)'
      targetValue: '1'        # Scale when 1+ requests waiting
      clampMin: '0'
      clampMax: '500'
      operationOverTime: 'last_one'
  advanced:
    scalingModifiers:
      formula: "running + (waiting * 5)"  # Weight waiting requests 5x (very aggressive)
      target: "5"             # Lower target = faster scaling decision
      activationTarget: "1"   # Activate scaling immediately when load > 1
    horizontalPodAutoscalerConfig:
      behavior:
        scaleDown:
          stabilizationWindowSeconds: 300
          policies:
          - type: Percent
            value: 50
            periodSeconds: 60
        scaleUp:
          stabilizationWindowSeconds: 0   # No stabilization delay
          policies:
          - type: Percent
            value: 500        # Allow 500% increase per period
            periodSeconds: 10 # Every 10 seconds
          - type: Pods
            value: 8          # Or add up to 8 pods per period
            periodSeconds: 10
          selectPolicy: Max
