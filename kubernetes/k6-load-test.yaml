apiVersion: v1
kind: ConfigMap
metadata:
  name: k6-script
  namespace: default
data:
  load-test.js: |
    import http from 'k6/http';
    import { check, sleep } from 'k6';

    export const options = {
      scenarios: {
        aggressive_ramp: {
          executor: 'ramping-vus',
          startVUs: 5,
          stages: [
            // Ramp to 30 VUs in 1 min (trigger proactive scaling)
            { duration: '1m', target: 30 },
            // Hold at 30 VUs for 2 min (let pods scale)
            { duration: '2m', target: 30 },
            // Ramp to 80 VUs in 1 min (aggressive load)
            { duration: '1m', target: 80 },
            // Hold at 80 VUs for 3 min (test at scale)
            { duration: '3m', target: 80 },
            // Ramp down
            { duration: '1m', target: 0 },
          ],
        },
      },
      thresholds: {
        http_req_duration: ['p(95)<15000'], // 95% under 15s
        http_req_failed: ['rate<0.1'],      // Less than 10% failures
      },
    };

    export default function () {
      const url = 'http://vllm-service.default.svc.cluster.local:8000/v1/completions';
      
      const payload = JSON.stringify({
        model: 'TheBloke/Mistral-7B-Instruct-v0.2-AWQ',
        prompt: 'Explain Kubernetes autoscaling in one sentence.',
        max_tokens: 50,
        temperature: 0.7,
      });

      const params = {
        headers: { 'Content-Type': 'application/json' },
        timeout: '30s',
      };

      const res = http.post(url, payload, params);
      
      check(res, {
        'status is 200': (r) => r.status === 200,
        'has completion': (r) => {
          try {
            const body = JSON.parse(r.body);
            return body.choices && body.choices.length > 0;
          } catch (e) {
            return false;
          }
        },
      });

      // No sleep - send requests as fast as possible to build queue
    }
---
apiVersion: batch/v1
kind: Job
metadata:
  name: k6-load-test
  namespace: default
spec:
  backoffLimit: 0
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: k6
        image: grafana/k6:latest
        command: ["k6", "run", "/scripts/load-test.js"]
        volumeMounts:
        - name: k6-script
          mountPath: /scripts
      volumes:
      - name: k6-script
        configMap:
          name: k6-script
